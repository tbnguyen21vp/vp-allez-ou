<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <%- include('partials/head') %>
    <link rel="stylesheet" type="text/css" href="/css/tourSearch.css">
    <!-- <title>Du lịch</title> -->
    <!-- <script defer src="/js/tourSearch.js"></script> -->
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
    <header class="d-flex justify-content-center">
        <div>

            <%- include('partials/navbar', {title: title}) %>
        </div>
        <!-- <div class="header-booking">
            <div class="booking-info option-select">
                <div class="col">
                    <div class="block">
                        <div class="block-col1">
                            <img src="/img/tourSearch/location.svg" alt="">
                        </div>
                        <div class="block-col2">
                            <div class="block-row1">Điểm đi</div>
                            <div class="block-row2">TP.Hồ Chí Minh</div>
                        </div>
                    </div>
                    <div class="sep-block" style="margin-left: 48px; margin-right: 48px;"><img src="/img/tourSearch/dir.svg" alt=""></div>
                    <div class="block">
                        <div class="block-col1">
                            <img src="/img/tourSearch/location.svg" alt="">
                        </div>
                        <div class="block-col2">
                            <div class="block-row1">Điểm đến</div>
                            <div class="block-row2">Hà Nội</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="sep-block" style="width: 8px;"></div>
            <div class="booking-info option-down">
                <div class="col">
                    <div class="block">
                        <div class="block-col1">
                            <img src="/img/tourSearch/calendar.svg" alt="">
                        </div>
                        <div class="block-col2">
                            <div class="block-row1">Ngày đi</div>
                            <div class="block-row2">18/06/2023</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="sep-block" style="width: 20px;"></div>
            <div class="find-filter" onclick="findButtonActive()" style="cursor: pointer;">
                <img src="/img/tourSearch/find.png" alt="">
            </div>
        </div> -->
        <div class="search d-inline-flex">
            <div class="search-place d-flex m-0">
                <div class="d-flex search-place__start">
                    <div class="icon-bg d-flex m-auto">
                        <img src="/img/home/location.png" class="location-icon m-auto" />
                    </div>
                    <div class="search-start d-flex flex-column">
                        <h3>Điểm đi</h3>
                        <select class="form-select" aria-label="Default select example" id="startPoint">

                        </select>
                    </div>
                </div>
                <div class="d-flex mx-5">
                    <img src="/img/home/exchange.png" class="exchange-icon m-auto" />
                </div>
                <div class="d-flex search-place__end">
                    <div class="icon-bg d-flex m-auto">
                        <img src="/img/home/location.png" class="location-icon m-auto" />
                    </div>
                    <div class="search-start d-flex flex-column">
                        <h3>Điểm đến</h3>
                        <select class="form-select search-end-point" aria-label="Default select example" id="endPoint">

                        </select>
                    </div>
                </div>
            </div>
            <div class="search-line m-auto"></div>
            <div class="d-flex search-date-and-icon">
                <div class="search-date d-flex mx-4">
                    <div class="d-flex search-date__start">
                        <div class="icon-bg d-flex m-auto">
                            <img src="/img/home/calendar.png" class="location-icon m-auto" />
                        </div>
                        <div class="search-start d-flex flex-column">
                            <h3>Ngày đi</h3>
                            <input class="form-control form__start-date" type="date" id="search_travel-date" />
                        </div>
                    </div>
                    <div class="d-flex search-date__tour">
                        <div class="icon-bg d-flex m-auto">
                            <img src="/img/home/calendar.png" class="location-icon m-auto" />
                        </div>
                        <div class="search-start d-flex flex-column">
                            <h3>Số ngày</h3>
                            <select class="form-select" aria-label="Default select example" id="search_num-of-date">
                                <option class="form-option" value="">Tất cả</option>
                                <option class="form-option" value="1">1-3 ngày</option>
                                <option class="form-option" value="2">4-7 ngày</option>
                                <option class="form-option" value="3">8-14 ngày</option>
                                <option class="form-option" value="4">trên 14 ngày</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="search-click d-flex m-auto">
                    <a class="navbar-text__hightlight search-button d-flex" onclick="searchTour()">
                        <img src="/img/home/search.png" class="location-icon m-auto" />
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main>

        <div id="travel">
            <div class="travel-container">
                <div class="path">

                </div>
                <a class="navbar-text__hightlight fav-place__tag" onclick="findButtonActive()">Bộ lọc</a>
                <div class="travel-content">
                    <div class="filter web-filter">
                        <div class="title">
                            BỘ LỌC
                        </div>
                        <div class="sub-filter">
                            <div class="sub-filter-name">
                                <div class="sep-line"></div>
                                <div class="name">Số ngày</div>
                                <div class="sep-line"></div>
                            </div>
                            <div class="sub-filter-option">
                                <label class="f-option">1-3 ngày
                                    <input type="radio" checked="checked" value="option1" name="f1-radio">
                                    <span class="checkmark"></span>
                                </label>
                                <label class="f-option">4-7 ngày
                                    <input type="radio" value="option2" name="f1-radio">
                                    <span class="checkmark"></span>
                                </label>
                                <label class="f-option">8-14 ngày
                                    <input type="radio" value="option3" name="f1-radio">
                                    <span class="checkmark"></span>
                                </label>
                                <label class="f-option">trên 14 ngày
                                    <input type="radio" value="option4" name="f1-radio">
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                        </div>
                        <div class="sub-filter">
                            <div class="sub-filter-name">
                                <div class="sep-line"></div>
                                <div class="name">Số người</div>
                                <div class="sep-line"></div>
                            </div>
                            <div class="sub-filter-option">
                                <label class="f-option">1 người
                                    <input type="radio" checked="checked" value="option1" name="f2-radio">
                                    <span class="checkmark"></span>
                                </label>
                                <label class="f-option">2 người
                                    <input type="radio" value="option2" name="f2-radio">
                                    <span class="checkmark"></span>
                                </label>
                                <label class="f-option">3-6 người
                                    <input type="radio" value="option3" name="f2-radio">
                                    <span class="checkmark"></span>
                                </label>
                                <label class="f-option">trên 7 người
                                    <input type="radio" value="option4" name="f2-radio">
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                        </div>
                        <div class="sub-filter">
                            <div class="sub-filter-name">
                                <div class="sep-line"></div>
                                <div class="name">Ngân sách</div>
                                <div class="sep-line"></div>
                            </div>
                            <div class="sub-filter-slider">
                                <div class="f-price-slider"></div>
                                <div class="f-price-range">
                                    <p>
                                        <span class="f-price-min"></span> - <span class="f-price-max"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="sep-line"></div>
                        <div class="sub-filter">
                            <div class="sub-filter-confirm">
                                <button class="sub-filter-button" onclick="filterDelete()">Xóa bộ lọc</button>
                                <button class="sub-filter-button" onclick="filterActive()">Áp dụng</button>
                            </div>
                        </div>
                    </div>
                    <div class="filter-screen"
                        style="width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; z-index: 3; background-color: rgba(0, 0, 0, 0.3);">
                        <div class="filter mobile-filter">
                            <div class="title">
                                BỘ LỌC
                            </div>
                            <div class="sep-line"></div>
                            <div class="sub-filter" style="display: flex; justify-content: space-between;">
                                <div class="sub-filter-name">
                                    <div class="name">Số ngày</div>
                                </div>
                                <div class="sub-filter-option">
                                    <select class="f-dropbox f1-dropbox">
                                        <option value="option1">1-3 ngày</option>
                                        <option value="option2">4-7 ngày</option>
                                        <option value="option3">8-14 ngày</option>
                                        <option value="option4">trên 14 ngày</option>
                                    </select>
                                </div>
                            </div>
                            <div class="sub-filter" style="display: flex; justify-content: space-between;">
                                <div class="sub-filter-name">
                                    <div class="name">Số người</div>
                                </div>
                                <div class="sub-filter-option">
                                    <select class="f-dropbox f2-dropbox">
                                        <option value="option1">1 người</option>
                                        <option value="option2">2 người</option>
                                        <option value="option3">3-6 người</option>
                                        <option value="option4">trên 7 người</option>
                                    </select>
                                </div>
                            </div>
                            <div class="sub-filter">
                                <div class="sub-filter-name">
                                    <div class="name">Ngân sách</div>
                                </div>
                                <div class="sub-filter-slider">
                                    <div class="f-price-slider"></div>
                                    <div class="f-price-range">
                                        <p>
                                            <span class="f-price-min"></span> - <span class="f-price-max"></span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="sep-line"></div>
                            <div class="sub-filter">
                                <div class="sub-filter-name">
                                    <div class="name">Sắp xếp</div>
                                </div>
                                <div class="sub-filter-sort">
                                    <div class="tour-sort">
                                        <div class="sort-block" onclick="sortButtonActive(this, 0)"
                                            style="display: block;">
                                            <div class="sort-block-content">Ngày khởi hành</div>
                                            <img src="/img/tourSearch/up-arrow.svg" alt="">
                                        </div>
                                        <div style="height: 11px; display: block;"></div>
                                        <div class="sort-block" onclick="sortButtonActive(this, 1)"
                                            style="display: block;">
                                            <div class="sort-block-content">Giá tiền</div>
                                            <img src="/img/tourSearch/up-arrow.svg" alt="">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="sep-line"></div>
                            <div class="sub-filter">
                                <div class="sub-filter-confirm">
                                    <button class="sub-filter-button" onclick="findButtonActive()">Hủy</button>
                                    <button class="sub-filter-button" onclick="findButtonActive(), filterDelete()">Xóa
                                        bộ lọc</button>
                                    <button class="sub-filter-button" onclick="findButtonActive(), filterActive()">Áp
                                        dụng</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="listtour">
                        <div class="tour-sort">
                            <div class="sort-block" onclick="sortButtonActive(this, 0)">
                                <div class="sort-block-content">Ngày khởi hành</div>
                                <img src="/img/tourSearch/up-arrow.svg" alt="">
                            </div>
                            <div style="width: 15px; display: inline-block;"></div>
                            <div class="sort-block" onclick="sortButtonActive(this, 1)">
                                <div class="sort-block-content">Giá tiền</div>
                                <img src="/img/tourSearch/up-arrow.svg" alt="">
                            </div>
                        </div>
                        <div id="travel-tour" class="row2">

                        </div>
                        <div id="page-control">
                            <div class="page-button" onclick="previousPage()" style="cursor: pointer;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="8" height="15" viewBox="0 0 8 15"
                                    fill="none">
                                    <path d="M7.21044 0.841675L0.894653 7.03363L7.21044 13.4733" stroke="black"
                                        stroke-width="1.26316" stroke-linecap="round" />
                                </svg>
                            </div>
                            <div id="page-info"></div>
                            <div class="page-button" onclick="nextPage()" style="cursor: pointer;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="8" height="15" viewBox="0 0 8 15"
                                    fill="none">
                                    <path d="M0.736945 13.4733L7.05273 7.28132L0.736946 0.841687" stroke="black"
                                        stroke-width="1.26316" stroke-linecap="round" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer>
        <%- include('partials/footer') %>
    </footer>
    <script>
        //let response = null;
        const contentPerPage = 10;
        let filter = {};
        var listTravel;
        var currentPage;
        var limitPage;
        let sortButtonState = [0, 0];
        getListTravel();
        function getListTravel() {
            // response = await axios.get("/tourCards");
            listTravel = JSON.parse('<%- JSON.stringify(tourCards) %>');
            listTravel = Array.isArray(listTravel) ? listTravel : [listTravel];
            console.log(listTravel);
            loadData();
            renderPage();
        }
        function sortData(type, dir) {
            if (type == "price") {
                if (dir == 1) listTravel.sort((travel1, travel2) => travel1.price - travel2.price);
                else listTravel.sort((travel1, travel2) => travel2.price - travel1.price);
            }
            else {
                listTravel.sort(compareEvents);
                if (dir == 2) listTravel.reverse();
            }
            currentPage = 0;
        }
        function loadData() {
            // listTravel = response.data;
            for (const key in filter) {
                if (key == "budget") {
                    listTravel = listTravel.filter(item => item.price >= parseInt(filter[key][0]) && item.price <= parseInt(filter[key][1]));
                }
                else if (key == "numday") {
                    if (filter[key] == "option1") {
                        listTravel = listTravel.filter(item => item.numOfDays >= 1 && item.numOfDays <= 3);
                    }
                    else if (filter[key] == "option2") {
                        listTravel = listTravel.filter(item => item.numOfDays >= 4 && item.numOfDays <= 7);
                    }
                    else if (filter[key] == "option3") {
                        listTravel = listTravel.filter(item => item.numOfDays >= 8 && item.numOfDays <= 14);
                    }
                    else {
                        listTravel = listTravel.filter(item => item.numOfDays >= 14);
                    }
                }
                else if (key == "slot") {
                    if (filter[key] == "option1") {
                    }
                    else if (filter[key] == "option2") {
                    }
                    else if (filter[key] == "option3") {
                    }
                    else {
                    }
                }
            }
            if (sortButtonState[0] != 0) {
                sortData("date", sortButtonState[0]);
            }
            else if (sortButtonState[1] != 0) {
                sortData("price", sortButtonState[1]);
            }
            for (var i = 0; i < listTravel.length; i++) {
                listTravel[i].priceformat = listTravel[i].price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "đ";
            }
            currentPage = 0;
            limitPage = Math.ceil(listTravel.length / contentPerPage);
        }
        function cardTravelTour(travel) {
            return `
<div class="col">
    <img src="${travel.cardImgUrl}" alt="">
    <div class="content">
        <div class="sub-content">
            <h3>${travel.date} - ${travel.numOfDays}N${travel.numOfDays - 1}Đ - Giờ đi: ${travel.time}</h3>
            <h1>${travel.name}</h1>
        </div>
        <h2>${travel.priceformat}</h2>
        <div class="content-more"><a href="/tours/${travel.code}">Xem thêm</a></div>
    </div>
</div>
`;
        }
        function compareEvents(event1, event2) {
            const date1 = new Date(event1.date);
            const date2 = new Date(event2.date);
            const time1 = event1.time;
            const time2 = event2.time;
            if (date1 < date2) {
                return -1;
            } else if (date1 > date2) {
                return 1;
            } else {
                if (time1 < time2) {
                    return -1;
                } else if (time1 > time2) {
                    return 1;
                } else {
                    return 0;
                }
            }
        }
        function renderPage() {
            listTravelCurrent = listTravel.slice(currentPage * contentPerPage, (currentPage + 1) * contentPerPage);
            const travelTour = document.getElementById('travel-tour');
            const pageInfo = document.getElementById('page-info');
            var buttons = document.querySelectorAll("#page-control .page-button");
            travelTour.innerHTML = "";
            if (listTravelCurrent.length == 0) {
                for (var i = 0; i < buttons.length; i++) {
                    buttons[i].style.display = "none";
                }
                pageInfo.innerHTML = "Không tìm thấy kết quả";
                return;
            }
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].style.display = "block";
            }
            listTravelCurrent.forEach(travel => {
                const card = cardTravelTour(travel);
                travelTour.insertAdjacentHTML('beforeend', card);
            });
            pageInfo.innerHTML = (currentPage + 1).toString() + " / " + limitPage.toString();
        }
        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                renderPage();
            }
        }
        function nextPage() {
            if (currentPage + 1 < limitPage) {
                currentPage++;
                renderPage();
            }
        }
        // ----------------------------------------------------
        function sortButtonActive(button, index) {
            sortButtonState[1 - index] = 0;
            sortButtonState[index] = (sortButtonState[index] + 1) % 3;
            var images = document.querySelectorAll("#travel .tour-sort .sort-block img");
            for (var i = 0; i < images.length; i++) {
                images[i].src = "/img/tourSearch/up-arrow.svg";
            }
            var image = button.querySelector('img');
            if (sortButtonState[index] == 2) image.src = "/img/tourSearch/down-arrow.svg";
            else image.src = "/img/tourSearch/up-arrow.svg";
            var sortButtons = document.querySelectorAll("#travel .tour-sort .sort-block");
            for (var i = 0; i < sortButtons.length; i++) {
                sortButtons[i].style.backgroundColor = '#6E6A8E';
            }
            if (sortButtonState[index] == 0) button.style.backgroundColor = '#6E6A8E';
            else button.style.backgroundColor = '#F14868';
            if (sortButtonState[0] != 0) {
                sortData("date", sortButtonState[0]);
                renderPage();
            }
            else if (sortButtonState[1] != 0) {
                sortData("price", sortButtonState[1]);
                renderPage();
            }
        }
        var priceSlider = document.getElementsByClassName('f-price-slider');
        var priceMin = document.getElementsByClassName('f-price-min');
        var priceMax = document.getElementsByClassName('f-price-max');
        for (var i = 0; i < priceSlider.length; i++) {
            noUiSlider.create(priceSlider[i], {
                start: [2000000, 11000000],
                connect: true,
                range: {
                    'min': 0,
                    'max': 20000000
                },
                step: 1000000
            });
        }
        function filterDelete() {
            // if(filter == {}) return;
            filter = {};
            loadData();
            renderPage();
        }
        function filterActive() {
            filter = {};
            var sliderIndex = (window.innerWidth > 900) ? 0 : 1;
            filter.budget = [priceSlider[sliderIndex].noUiSlider.get()[0], priceSlider[sliderIndex].noUiSlider.get()[1]];
            var check1;
            var check2;
            if (window.innerWidth > 900) {
                check1 = document.querySelector('input[name="f1-radio"]:checked');
                check2 = document.querySelector('input[name="f2-radio"]:checked');
            }
            else {
                check1 = document.querySelector('.f1-dropbox');
                check2 = document.querySelector('.f2-dropbox');
            }
            filter.numday = check1.value;
            filter.slot = check2.value;
            loadData();
            renderPage();
        }
        function findButtonActive() {
            var filter = document.querySelector("#travel .travel-container .travel-content .filter-screen");
            if (filter.style.display === 'none') {
                filter.style.display = 'block';
            } else {
                filter.style.display = 'none';
            }
        }
        function toggleFilterVisibility() {
            var filterElement = document.querySelector('#travel .travel-container .travel-content .filter-screen');
            if (window.innerWidth > 900) {
                filterElement.style.display = 'none';
            }
        }
        window.addEventListener('load', toggleFilterVisibility);
        window.addEventListener('resize', toggleFilterVisibility);
        function formatPrice(price) {
            var parts = price.toString().split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            return parts.join(".");
        }
        for (var i = 0; i < priceSlider.length; i++) {
            priceSlider[i].noUiSlider.on('update', (function (index) {
                return function (values, handle) {
                    if (handle === 0) {
                        priceMin[index].innerHTML = formatPrice(Math.round(values[0]));
                    }
                    if (handle === 1) {
                        priceMax[index].innerHTML = formatPrice(Math.round(values[1]));
                    }
                };
            })(i));
        }
    </script>
</body>

</html>